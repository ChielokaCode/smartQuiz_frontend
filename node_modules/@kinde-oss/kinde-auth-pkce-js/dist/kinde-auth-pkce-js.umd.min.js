!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t(require("jwt-decode")):"function"==typeof define&&define.amd?define(["jwt-decode"],t):(e="undefined"!=typeof globalThis?globalThis:e||self).createKindeClient=t(e.jwtDecode)}(this,(function(e){"use strict";const t="3.0.30",r="pkce-code-verifier";var o;async function n(e){return function(e){const t=Array.from(new Uint8Array(e));return btoa(String.fromCharCode.apply(null,t)).replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/,"")}(await function(e){const t=(new TextEncoder).encode(e);return window.crypto.subtle.digest("SHA-256",t)}(e))}function a(){const e=new Uint32Array(28);return window.crypto.getRandomValues(e),Array.from(e,(e=>("0"+e.toString(16)).substr(-2))).join("")}!function(e){e.s="string",e.i="integer",e.b="boolean"}(o||(o={}));const i=e=>{const t=Math.floor(Date.now()/1e3);return e.exp>t},s=(()=>{let e={};return{reset:()=>{e={}},getItem:t=>e[t],removeItem:t=>{delete e[t]},setItem:(t,r)=>{e[t]=r}}})(),c=(e,t="access_token")=>{const r=s.getItem(`kinde_${t}`);return r?{name:e,value:r[e]}:null},d=(e,t="access_token")=>{const r=c(e,t);return r&&r.value},l=(e,t,r)=>{const n=d("feature_flags"),a=n&&n[e]?n[e]:{};if(null==a.v&&null==t)throw Error(`Flag ${e} was not found, and no default value has been provided`);if(r&&a.t&&r!==a.t)throw Error(`Flag ${e} is of type ${o[a.t]} - requested type ${o[r]}`);return{code:e,type:o[a.t||r],value:null==a.v?t:a.v,is_default:null==a.v}},u=(e,t)=>{try{return l(e,t,"b").value}catch(e){return console.error(e),e}},_=(e,t)=>{try{return l(e,t,"i").value}catch(e){return console.error(e),e}},g=(e,t)=>{try{return l(e,t,"s").value}catch(e){return console.error(e),e}},p=()=>({orgCodes:d("org_codes","id_token")??[]});return async o=>{if(!o)throw Error("Please provide your Kinde credentials");if(o!==Object(o))throw Error("The Kinde SDK must be initiated with an object");const{audience:f,client_id:m,domain:w,is_dangerously_use_local_storage:h=!1,redirect_uri:y,logout_uri:k=y,on_redirect_callback:v,scope:S="openid profile email offline",proxy_redirect_uri:$,_framework:I,_frameworkVersion:b}=o;if(f&&"string"!=typeof f)throw Error("Please supply a valid audience for your api");if(S&&"string"!=typeof S)throw Error("Please supply a valid scope");if(!y||"string"!=typeof o.redirect_uri)throw Error("Please supply a valid redirect_uri for your users to be redirected after successful authentication");if(!w||"string"!=typeof w)throw Error("Please supply a valid Kinde domain so we can connect to your account");if("boolean"!=typeof h)throw TypeError("Please supply a boolean value for is_dangerously_use_local_storage");const P=m||"spa@live",T=!h&&!w.includes(".kinde.com"),U={audience:f,client_id:P,redirect_uri:y,authorization_endpoint:`${w}/oauth2/auth`,token_endpoint:`${w}/oauth2/token`,requested_scopes:S,domain:w,_framework:I,_frameworkVersion:b},j=t=>{if(!t||t.error)return;const r=e.jwtDecode(t.access_token),o=e.jwtDecode(t.id_token);s.setItem("kinde_token",t),s.setItem("kinde_access_token",r),s.setItem("kinde_id_token",o),s.setItem("user",{id:o.sub,given_name:o.given_name,family_name:o.family_name,email:o.email,picture:o.picture}),h?localStorage.setItem("kinde_refresh_token",t.refresh_token):s.setItem("kinde_refresh_token",t.refresh_token)},E=async({tokenType:e}={tokenType:"kinde_access_token"})=>{const r=h?localStorage.getItem("kinde_refresh_token"):s.getItem("kinde_refresh_token");if(r||T)try{const o=await fetch(U.token_endpoint,{method:"POST",...T&&{credentials:"include"},headers:new Headers({"Content-type":"application/x-www-form-urlencoded; charset=UTF-8","Kinde-SDK":`\n            ${U._framework||"JavaScript"}/${U._frameworkVersion||t}`}),body:new URLSearchParams({client_id:U.client_id,grant_type:"refresh_token",...!T&&r&&{refresh_token:r}})}),n=await o.json();return j(n),"kinde_id_token"===e?n.id_token:n.access_token}catch(e){console.error(e)}},C=async e=>{const t=s.getItem("kinde_token");if(!t)return await E({tokenType:e});const r=s.getItem(e);return i(r)?"kinde_access_token"===e?t.access_token:t.id_token:await E({tokenType:e})},K=async()=>await C("kinde_access_token"),O=async e=>{const{app_state:t,start_page:o,is_create_org:i,org_name:s="",org_code:c,authUrlParams:d={}}=e,{state:l,code_challenge:u,url:_}=await(async(e,t)=>{const o=a(),i=a(),s=await n(i);return sessionStorage.setItem(`${r}-${o}`,JSON.stringify({codeVerifier:i,appState:t})),{state:o,code_challenge:s,url:new URL(e)}})(U.authorization_endpoint,t),g={redirect_uri:y,client_id:P,response_type:"code",scope:U.requested_scopes,code_challenge:u,code_challenge_method:"S256",state:l};o&&(g.start_page=o),c&&(g.org_code=c),i&&(g.is_create_org=String(i),g.org_name=s);const p=new URLSearchParams(Object.assign(d,g));f&&f.trim().split(/\s+/).forEach((e=>{p.append("audience",e)})),_.search=String(p),window.location.href=_.toString()},R=()=>s.getItem("user"),A=e=>{if(!e.has("code"))return!1;const{protocol:t,host:r,pathname:o}=window.location,n=$||`${t}//${r}${o}`;return n===y||n===`${y}/`};return await(async()=>{const e=new URLSearchParams(window.location.search);A(e)?await(async e=>{const o=e.get("code"),n=e.get("state"),a=e.get("error");a&&console.error(`Error returned from authorization server: ${a}`);const i=sessionStorage.getItem(`${r}-${n}`);if(i){const{appState:e,codeVerifier:a}=JSON.parse(i);try{const i=await fetch(U.token_endpoint,{method:"POST",...T&&{credentials:"include"},headers:new Headers({"Content-type":"application/x-www-form-urlencoded; charset=UTF-8","Kinde-SDK":`${U._framework||"JavaScript"}/${U._frameworkVersion||t}`}),body:new URLSearchParams({client_id:U.client_id,code:o,code_verifier:a,grant_type:"authorization_code",redirect_uri:U.redirect_uri})}),s=await i.json();j(s);const c=new URL(window.location.toString());c.search="",sessionStorage.removeItem(`${r}-${n}`);const d=R();window.history.pushState({},"",c),v&&v(d,e)}catch(e){console.error(e),sessionStorage.removeItem(`${r}-${n}`)}}else console.error("Invalid state")})(e):(T||h)&&await E()})(),{getToken:K,getIdToken:async()=>await C("kinde_id_token"),getUser:R,getUserProfile:async()=>{const e={Accept:"application/json",Authorization:`Bearer ${await K()}`};try{const t=await fetch(`${U.domain}/oauth2/v2/user_profile`,{method:"GET",headers:e}),r=await t.json();return s.setItem("user",{id:r.sub,given_name:r.given_name,family_name:r.family_name,email:r.email,picture:r.picture}),s.getItem("user")}catch(e){console.error(e)}},login:async e=>{await O({...e})},logout:async()=>{const e=new URL(`${U.domain}/logout`);try{s.reset(),h&&localStorage.removeItem("kinde_refresh_token");const t=new URLSearchParams({redirect:k});e.search=String(t),window.location.href=e.toString()}catch(e){console.error(e)}},register:async e=>{await O({...e,start_page:"registration"})},isAuthenticated:async()=>{const e=s.getItem("kinde_access_token");if(!e)return!1;return i(e)||await E(),!0},createOrg:async e=>{await O({...e,start_page:"registration",is_create_org:!0})},getClaim:c,getFlag:l,getBooleanFlag:u,getStringFlag:g,getIntegerFlag:_,getPermissions:()=>{const e=d("org_code");return{permissions:d("permissions")??[],orgCode:e}},getPermission:e=>{const t=d("org_code");return{isGranted:(d("permissions")??[]).some((t=>t===e)),orgCode:t}},getOrganization:()=>({orgCode:d("org_code")}),getUserOrganizations:p}}}));
